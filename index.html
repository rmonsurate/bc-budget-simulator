<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BC Budget 2026 — Interactive Simulator</title>
  <meta name="description" content="Interactive simulator for the BC 2026 provincial budget. Adjust tax brackets, spending, and explore the $13.3B deficit. See how admin overhead compares to 1975 levels." />

  <!-- Open Graph -->
  <meta property="og:title" content="BC Budget 2026 — Interactive Simulator" />
  <meta property="og:description" content="Adjust tax brackets, spending, and explore the $13.3B deficit interactively. See how admin overhead grew from 8% in 1975 to 22% today." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://bcbudget2026.monsurate.com" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="BC Budget 2026 — Interactive Simulator" />
  <meta name="twitter:description" content="Adjust tax brackets, spending, and explore the $13.3B deficit interactively." />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { width: 100%; height: 100%; }
    body { background: #080a0f; }

    /* Slider thumb — larger with hover glow */
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px;
      background: #fff; border-radius: 50%; cursor: pointer;
      box-shadow: 0 1px 6px rgba(0,0,0,0.5), 0 0 0 3px rgba(255,255,255,0.08);
      transition: box-shadow 0.2s ease;
    }
    input[type="range"]:hover::-webkit-slider-thumb {
      box-shadow: 0 1px 8px rgba(0,0,0,0.6), 0 0 0 5px rgba(255,255,255,0.12), 0 0 16px rgba(52,152,219,0.25);
    }
    input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; background: #fff;
      border-radius: 50%; cursor: pointer; border: none;
      box-shadow: 0 1px 6px rgba(0,0,0,0.5), 0 0 0 3px rgba(255,255,255,0.08);
    }
    input[type="range"]:hover::-moz-range-thumb {
      box-shadow: 0 1px 8px rgba(0,0,0,0.6), 0 0 0 5px rgba(255,255,255,0.12), 0 0 16px rgba(52,152,219,0.25);
    }
    input[type="range"] {
      transition: opacity 0.15s ease;
    }
    input[type="range"]:hover {
      opacity: 1 !important;
    }

    /* Scrollbar — dark themed */
    * { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.10) rgba(255,255,255,0.03); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.10); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.18); border: 2px solid transparent; background-clip: content-box; }

    /* Number input */
    input[type="number"] {
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
      color: #fff; border-radius: 6px; padding: 5px 8px; font-size: 13px;
      font-weight: 600; width: 68px; text-align: center; outline: none;
      font-variant-numeric: tabular-nums;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input[type="number"]:focus {
      border-color: rgba(52,152,219,0.5);
      box-shadow: 0 0 0 3px rgba(52,152,219,0.12);
    }

    /* Smooth transitions for interactive elements */
    button { transition: all 0.15s ease; }
    details summary { transition: color 0.15s ease; }

    /* ── Responsive layout classes ── */
    .page-gutter { padding-left: 32px; padding-right: 32px; }
    .metrics-row { display: flex; gap: 24px; justify-content: center; flex-wrap: wrap; }
    .metrics-row > div { text-align: center; }
    .preset-row { display: flex; gap: 6px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 2px; }
    .tab-bar { display: flex; gap: 0; padding: 0 32px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .content-area { padding: 24px 32px; overflow-y: auto; }
    .insight-cards { display: flex; gap: 16px; flex-wrap: wrap; }
    .ai-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }

    /* Tablet (≤1024px) */
    @media (max-width: 1024px) {
      .page-gutter { padding-left: 24px; padding-right: 24px; }
      .tab-bar { padding: 0 24px; }
      .content-area { padding: 20px 24px; }
    }

    /* Mobile (≤767px) */
    @media (max-width: 767px) {
      .page-gutter { padding-left: 16px; padding-right: 16px; }
      .tab-bar { padding: 0 16px; }
      .tab-bar button { padding: 10px 14px !important; font-size: 12px !important; }
      .content-area { padding: 16px 16px; max-height: none; }
      .insight-cards { flex-direction: column; }
      .ai-grid { grid-template-columns: 1fr; }
      .metrics-row { gap: 16px; }
      .hero-number { font-size: 48px !important; }
    }

    /* Small mobile (≤479px) */
    @media (max-width: 479px) {
      .page-gutter { padding-left: 12px; padding-right: 12px; }
      .tab-bar { padding: 0 12px; }
      .content-area { padding: 12px 12px; }
      .hero-number { font-size: 40px !important; }
      .metrics-row { gap: 12px; }
    }
  </style>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet" />
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useCallback, useMemo } = React;

// ═══════════════════════════════════════════════════════════════
// TYPE SCALE — 7 levels replaces 24 ad-hoc font sizes
// ═══════════════════════════════════════════════════════════════
const T = { display: 36, h1: 28, h2: 18, h3: 15, body: 13, caption: 11, micro: 10 };

// ═══════════════════════════════════════════════════════════════
// DATA: Tax Brackets (editable rates)
// ═══════════════════════════════════════════════════════════════
const DEFAULT_BRACKETS = [
  { id: "b1", range: "Up to $47,937", min: 0, max: 47937, oldRate: 5.06, rate: 5.60, population: 1680000, label: "1st — Low Income" },
  { id: "b2", range: "$47,937 – $95,875", min: 47937, max: 95875, oldRate: 7.70, rate: 7.70, population: 920000, label: "2nd — Lower-Mid" },
  { id: "b3", range: "$95,875 – $110,076", min: 95875, max: 110076, oldRate: 10.50, rate: 10.50, population: 280000, label: "3rd — Mid" },
  { id: "b4", range: "$110,076 – $133,664", min: 110076, max: 133664, oldRate: 12.29, rate: 12.29, population: 220000, label: "4th — Upper-Mid" },
  { id: "b5", range: "$133,664 – $181,232", min: 133664, max: 181232, oldRate: 14.70, rate: 14.70, population: 180000, label: "5th — High" },
  { id: "b6", range: "$181,232 – $252,752", min: 181232, max: 252752, oldRate: 16.80, rate: 16.80, population: 95000, label: "6th — Very High" },
  { id: "b7", range: "Over $252,752", min: 252752, max: Infinity, oldRate: 20.50, rate: 20.50, population: 75000, label: "7th — Top" },
];

const DEFAULT_CORP_RATE = 12.0;
const BASELINE_CORP_REVENUE = 5.2;

// ═══════════════════════════════════════════════════════════════
// DATA: Granular Revenue
// ═══════════════════════════════════════════════════════════════
const REVENUE_ITEMS = [
  { id: "pit", name: "Personal Income Tax", baseline: 15.0, color: "#e74c3c", cat: "tax" },
  { id: "cit", name: "Corporate Income Tax", baseline: 5.2, color: "#e67e22", cat: "tax" },
  { id: "pst", name: "Provincial Sales Tax", baseline: 10.2, color: "#f1c40f", cat: "tax" },
  { id: "ptt", name: "Property Transfer Tax", baseline: 2.4, color: "#2ecc71", cat: "tax" },
  { id: "schooltax", name: "Property & School Tax", baseline: 3.2, color: "#1abc9c", cat: "tax" },
  { id: "spectax", name: "Speculation & Vacancy Tax", baseline: 0.3, color: "#16a085", cat: "tax" },
  { id: "natgas", name: "Natural Gas Royalties", baseline: 2.8, color: "#3498db", cat: "resource" },
  { id: "forest", name: "Forestry Revenue", baseline: 0.6, color: "#27ae60", cat: "resource" },
  { id: "mining", name: "Mining & Minerals", baseline: 0.9, color: "#2980b9", cat: "resource" },
  { id: "federal", name: "Federal Health Transfer", baseline: 7.2, color: "#9b59b6", cat: "transfer" },
  { id: "fedother", name: "Federal Other Transfers", baseline: 6.6, color: "#8e44ad", cat: "transfer" },
  { id: "hydro", name: "BC Hydro Net Income", baseline: 2.8, color: "#6c5ce7", cat: "crown" },
  { id: "icbc", name: "ICBC Net Income", baseline: 2.0, color: "#a29bfe", cat: "crown" },
  { id: "ldb", name: "Liquor Distribution", baseline: 1.4, color: "#fd79a8", cat: "crown" },
  { id: "fees", name: "Fees, Licenses & Fines", baseline: 3.6, color: "#636e72", cat: "other" },
  { id: "tobacco", name: "Tobacco Settlement/Tax", baseline: 4.2, color: "#b2bec3", cat: "other" },
  { id: "invest", name: "Investment Income & Other", baseline: 17.4, color: "#7f8c8d", cat: "other" },
];

// ═══════════════════════════════════════════════════════════════
// DATA: Granular Expenses with Admin/Frontline splits
// ═══════════════════════════════════════════════════════════════
const EXPENSE_ITEMS = [
  // HEALTHCARE ($32B total)
  { id: "h_hospitals", name: "Hospitals & Acute Care", baseline: 12.8, color: "#e74c3c", sector: "health", adminPct: 18, desc: "Operating 17 major facilities. $11.1B capital over 3 years." },
  { id: "h_physicians", name: "Physician Services (MSP)", baseline: 6.2, color: "#ff6b6b", sector: "health", adminPct: 8, desc: "Fee-for-service and salaried physician payments." },
  { id: "h_pharma", name: "PharmaCare & Drugs", baseline: 2.4, color: "#ee5a24", sector: "health", adminPct: 12, desc: "Publicly-funded prescription drug coverage." },
  { id: "h_mentalhealth", name: "Mental Health & Addictions", baseline: 1.8, color: "#d63031", sector: "health", adminPct: 15, desc: "$131M new for intensive treatment. Complex care housing." },
  { id: "h_longterm", name: "Long-Term & Home Care", baseline: 3.2, color: "#c0392b", sector: "health", adminPct: 14, desc: "Residential care, assisted living, home support." },
  { id: "h_admin", name: "Health Authority Admin & Corporate", baseline: 3.8, color: "#b71c1c", sector: "health", adminPct: 95, desc: "HA executive, corporate services, IT projects (CST: $799M)." },
  { id: "h_other", name: "Other Health (Ambulance, Public Health)", baseline: 1.8, color: "#e57373", sector: "health", adminPct: 20, desc: "BC Emergency Health Services, public health programs." },

  // K-12 EDUCATION ($9.2B)
  { id: "e_teachers", name: "Teacher Salaries & Benefits", baseline: 4.8, color: "#e67e22", sector: "k12", adminPct: 0, desc: "37,000 FTE teachers. $167M Classroom Enhancement Fund." },
  { id: "e_support", name: "Support Staff & Ed Assistants", baseline: 1.6, color: "#f39c12", sector: "k12", adminPct: 5, desc: "Educational assistants, custodians, library, counsellors (1,040 FTE)." },
  { id: "e_admin", name: "School & District Administration", baseline: 1.2, color: "#d35400", sector: "k12", adminPct: 90, desc: "3,080 FTE admin (principals, supers). +339 since 2016-17." },
  { id: "e_special", name: "Special Education & Inclusive", baseline: 0.9, color: "#e08d3c", sector: "k12", adminPct: 8, desc: "$838M targeted funding. Autism diagnoses up 1,400% since 2002." },
  { id: "e_facilities", name: "School Operations & Maintenance", baseline: 0.7, color: "#f0b27a", sector: "k12", adminPct: 15, desc: "Building maintenance, HVAC, seismic compliance." },

  // POST-SECONDARY ($6.8B)
  { id: "ps_teaching", name: "University & College Instruction", baseline: 3.4, color: "#f1c40f", sector: "postsec", adminPct: 10, desc: "Faculty salaries, teaching programs across BC institutions." },
  { id: "ps_trades", name: "Trades & Skills Training", baseline: 0.8, color: "#f7dc6f", sector: "postsec", adminPct: 12, desc: "$283M new funding to double apprenticeship seats by 2028-29." },
  { id: "ps_research", name: "Research & Innovation", baseline: 0.6, color: "#fad7a0", sector: "postsec", adminPct: 20, desc: "University research grants, innovation programs." },
  { id: "ps_admin", name: "Post-Secondary Administration", baseline: 1.2, color: "#d4ac0d", sector: "postsec", adminPct: 92, desc: "University admin, executive compensation, corporate services." },
  { id: "ps_studentaid", name: "Student Aid & Grants", baseline: 0.8, color: "#b7950b", sector: "postsec", adminPct: 10, desc: "BC Student Loans, grants, Indigenous education support." },

  // SOCIAL ($5.8B)
  { id: "s_disability", name: "Disability Assistance", baseline: 2.2, color: "#2ecc71", sector: "social", adminPct: 12, desc: "PWD benefits. New $6K/yr children & youth supplement from 2027." },
  { id: "s_income", name: "Income Assistance", baseline: 1.4, color: "#27ae60", sector: "social", adminPct: 14, desc: "BC Employment & Assistance for employable individuals." },
  { id: "s_bcfamily", name: "BC Family Benefit", baseline: 1.2, color: "#1abc9c", sector: "social", adminPct: 5, desc: "Income-tested family benefit. Tax-free monthly payments." },
  { id: "s_admin", name: "Social Services Administration", baseline: 1.0, color: "#16a085", sector: "social", adminPct: 88, desc: "Ministry admin, case management overhead, IT systems." },

  // CHILDREN & CHILD CARE ($3.8B)
  { id: "cc_providers", name: "Child Care Provider Funding", baseline: 2.0, color: "#00b894", sector: "children", adminPct: 8, desc: "$10/day ChildCareBC. Only ~10% of spaces at $10/day." },
  { id: "cc_creation", name: "New Space Creation", baseline: 0.6, color: "#00cec9", sector: "children", adminPct: 15, desc: "Building new child care spaces. 11,800 spaces onboarding." },
  { id: "cc_family", name: "Family & Child Welfare", baseline: 0.8, color: "#0984e3", sector: "children", adminPct: 18, desc: "Child protection, foster care, family services." },
  { id: "cc_admin", name: "Child Care System Admin", baseline: 0.4, color: "#74b9ff", sector: "children", adminPct: 90, desc: "Program oversight, licensing, provider enrollment." },

  // HOUSING ($2.6B)
  { id: "ho_rental", name: "Rental Supports & Subsidies", baseline: 0.9, color: "#a29bfe", sector: "housing", adminPct: 8, desc: "$150M/yr more for lower income families and seniors." },
  { id: "ho_construction", name: "Social Housing Construction", baseline: 0.8, color: "#6c5ce7", sector: "housing", adminPct: 12, desc: "BC Housing new builds, modular housing, supportive housing." },
  { id: "ho_homelessness", name: "Homelessness & Shelters", baseline: 0.5, color: "#5f27cd", sector: "housing", adminPct: 15, desc: "Emergency shelters, outreach, Housing First programs." },
  { id: "ho_admin", name: "Housing Admin & BC Housing Corp", baseline: 0.4, color: "#341f97", sector: "housing", adminPct: 85, desc: "BC Housing corporate operations, policy, oversight." },

  // PUBLIC SAFETY ($4.2B)
  { id: "ps_police", name: "Policing & RCMP", baseline: 1.8, color: "#3498db", sector: "safety", adminPct: 20, desc: "Provincial policing, RCMP contracts, municipal support." },
  { id: "ps_courts", name: "Courts & Justice", baseline: 0.8, color: "#2980b9", sector: "safety", adminPct: 25, desc: "Provincial courts, Legal Aid, prosecution services." },
  { id: "ps_corrections", name: "Corrections", baseline: 0.6, color: "#1565c0", sector: "safety", adminPct: 22, desc: "Provincial prisons, community corrections, probation." },
  { id: "ps_fire", name: "Wildfire & Emergency Mgmt", baseline: 0.6, color: "#0d47a1", sector: "safety", adminPct: 15, desc: "BC Wildfire Service, emergency management, flood mitigation." },
  { id: "ps_jsadmin", name: "Justice System Admin", baseline: 0.4, color: "#1a237e", sector: "safety", adminPct: 90, desc: "Ministry admin, AG office, regulatory bodies." },

  // TRANSPORTATION ($3.2B)
  { id: "t_highways", name: "Highway Maintenance & Ops", baseline: 1.2, color: "#e91e63", sector: "transport", adminPct: 12, desc: "Road maintenance, snowplowing, bridge upkeep." },
  { id: "t_transit", name: "Transit Operations & Expansion", baseline: 1.1, color: "#c2185b", sector: "transport", adminPct: 15, desc: "TransLink, BC Transit. Surrey-Langley SkyTrain." },
  { id: "t_capital", name: "Transport Capital Projects", baseline: 0.6, color: "#880e4f", sector: "transport", adminPct: 18, desc: "Major project construction, bridge replacements." },
  { id: "t_admin", name: "Transport Ministry Admin", baseline: 0.3, color: "#ad1457", sector: "transport", adminPct: 88, desc: "Ministry overhead, planning, policy, regulation." },

  // ENVIRONMENT ($2.4B)
  { id: "env_climate", name: "Climate Action & Clean Energy", baseline: 0.7, color: "#4caf50", sector: "environ", adminPct: 20, desc: "CleanBC programs, carbon reduction initiatives." },
  { id: "env_forestry", name: "Forestry & Land Management", baseline: 0.6, color: "#388e3c", sector: "environ", adminPct: 18, desc: "$50M new for forestry stability. Permit streamlining." },
  { id: "env_parks", name: "Parks & Conservation", baseline: 0.4, color: "#2e7d32", sector: "environ", adminPct: 12, desc: "BC Parks operations, wildlife management." },
  { id: "env_admin", name: "Environment Ministry Admin", baseline: 0.3, color: "#1b5e20", sector: "environ", adminPct: 88, desc: "Ministry overhead, environmental assessment office." },
  { id: "env_water", name: "Water & Waste Management", baseline: 0.4, color: "#66bb6a", sector: "environ", adminPct: 15, desc: "Water treatment, watershed protection, remediation." },

  // FIXED / NON-DISCRETIONARY
  { id: "debt", name: "Debt Servicing (Interest)", baseline: 6.5, color: "#95a5a6", sector: "fixed", adminPct: 0, desc: "Interest on $183B debt. 6.2\u00a2 per revenue dollar. Non-negotiable." },
  { id: "contingency", name: "Contingencies", baseline: 5.0, color: "#7f8c8d", sector: "fixed", adminPct: 0, desc: "$5B buffer for emergencies, bargaining, trade uncertainty." },

  // OTHER GOV
  { id: "og_it", name: "Government IT & Digital", baseline: 1.8, color: "#bdc3c7", sector: "other", adminPct: 40, desc: "OCIO, digital services, major IT projects across government." },
  { id: "og_exec", name: "Executive & Legislature", baseline: 0.5, color: "#aab", sector: "other", adminPct: 95, desc: "Premier's office, Legislature, cabinet operations." },
  { id: "og_hr", name: "HR, Finance & Central Services", baseline: 1.4, color: "#95a5a6", sector: "other", adminPct: 90, desc: "PSA, corporate finance, procurement, shared services." },
  { id: "og_indigenous", name: "Indigenous Relations", baseline: 0.8, color: "#78909c", sector: "other", adminPct: 25, desc: "Treaty negotiations, Indigenous service delivery." },
  { id: "og_econ", name: "Economic Development", baseline: 0.6, color: "#607d8b", sector: "other", adminPct: 30, desc: "$400M BC Strategic Investments. Permitting acceleration." },
  { id: "og_misc", name: "Other Ministries & Programs", baseline: 9.5, color: "#546e7a", sector: "other", adminPct: 30, desc: "Agriculture, tourism, labour, immigration, arts, misc." },
];

const SECTORS = [
  { id: "health", name: "Healthcare", color: "#e74c3c", icon: "\u{1F3E5}" },
  { id: "k12", name: "K-12 Education", color: "#e67e22", icon: "\u{1F393}" },
  { id: "postsec", name: "Post-Secondary", color: "#f1c40f", icon: "\u{1F3DB}\uFE0F" },
  { id: "social", name: "Social Services", color: "#2ecc71", icon: "\u{1F6E1}\uFE0F" },
  { id: "children", name: "Children & Care", color: "#00b894", icon: "\u{1F476}" },
  { id: "housing", name: "Housing", color: "#6c5ce7", icon: "\u{1F3E0}" },
  { id: "safety", name: "Public Safety", color: "#3498db", icon: "\u2696\uFE0F" },
  { id: "transport", name: "Transportation", color: "#e91e63", icon: "\u{1F68C}" },
  { id: "environ", name: "Environment", color: "#4caf50", icon: "\u{1F332}" },
  { id: "fixed", name: "Fixed Costs", color: "#95a5a6", icon: "\u{1F512}" },
  { id: "other", name: "Other Government", color: "#7f8c8d", icon: "\u{1F3E2}" },
];

const ADMIN_HISTORY = [
  { year: 1975, healthAdminPct: 8, eduAdminPct: 6, label: "1975 Baseline" },
  { year: 1985, healthAdminPct: 10, eduAdminPct: 7, label: "" },
  { year: 1995, healthAdminPct: 12, eduAdminPct: 9, label: "" },
  { year: 2005, healthAdminPct: 14, eduAdminPct: 10, label: "" },
  { year: 2010, healthAdminPct: 15, eduAdminPct: 11, label: "" },
  { year: 2015, healthAdminPct: 16, eduAdminPct: 12, label: "" },
  { year: 2020, healthAdminPct: 18, eduAdminPct: 14, label: "COVID spike" },
  { year: 2024, healthAdminPct: 22, eduAdminPct: 16, label: "Current" },
  { year: 2026, healthAdminPct: 23, eduAdminPct: 17, label: "Budget 2026 (proj)" },
];

// ═══════════════════════════════════════════════════════════════
// PROTECTED: These items cannot be reduced below baseline
// (frontline education workers — teachers & support staff)
// ═══════════════════════════════════════════════════════════════
const PROTECTED_IDS = new Set([
  "e_teachers",      // K-12 Teacher Salaries & Benefits
  "e_support",       // K-12 Support Staff & Ed Assistants (EAs, custodians, library, counsellors)
  "e_special",       // Special Education & Inclusive — vulnerable students depend on this
  "ps_teaching",     // University & College Instruction (faculty)
  "ps_trades",       // Trades & Skills Training (apprentices)
  "h_physicians",    // Physician Services (MSP) — doctors
  "h_longterm",      // Long-Term & Home Care — seniors/vulnerable depend on this
  "h_mentalhealth",  // Mental Health & Addictions — crisis-level need
  "s_disability",    // Disability Assistance — PWD benefits, cannot cut
  "s_income",        // Income Assistance — last safety net for the most vulnerable
  "cc_providers",    // Child Care Provider Funding — $10/day childcare workers
  "cc_family",       // Family & Child Welfare — child protection
]);

// ═══════════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════════
const f = (v) => Math.abs(v) >= 1 ? `$${v.toFixed(1)}B` : `$${(v * 1000).toFixed(0)}M`;

function estimatePITRevenue(brackets) {
  let total = 0;
  brackets.forEach(b => {
    const avgIncome = b.max === Infinity ? 400000 : (b.min + b.max) / 2;
    const taxableInBracket = avgIncome - b.min;
    total += (b.rate / 100) * taxableInBracket * b.population;
  });
  return total / 1e9;
}

const baselinePIT = estimatePITRevenue(DEFAULT_BRACKETS);

// ═══════════════════════════════════════════════════════════════
// COMPONENTS
// ═══════════════════════════════════════════════════════════════
function MiniSlider({ value, onChange, min, max, step, color, label, format }) {
  return (
    <div style={{ display: "flex", alignItems: "center", gap: 10, minWidth: 0 }}>
      {label && <span style={{ fontSize: T.caption, color: "#888", minWidth: 32, flexShrink: 0 }}>{label}</span>}
      <input type="range" min={min} max={max} step={step} value={value} onChange={e => onChange(parseFloat(e.target.value))}
        style={{ flex: 1, height: 5, appearance: "none", WebkitAppearance: "none", background: `linear-gradient(to right, ${color} 0%, ${color} ${((value - min) / (max - min)) * 100}%, rgba(255,255,255,0.08) ${((value - min) / (max - min)) * 100}%, rgba(255,255,255,0.08) 100%)`, borderRadius: 3, outline: "none", cursor: "pointer", minWidth: 40 }} />
      <span style={{ fontSize: T.h3, fontWeight: 700, color: "#fff", fontVariantNumeric: "tabular-nums", minWidth: 48, textAlign: "right" }}>
        {format ? format(value) : value.toFixed(2)}
      </span>
    </div>
  );
}

function ExpenseSlider({ item, value, onChange }) {
  const pct = ((value - item.baseline) / item.baseline) * 100;
  const changed = Math.abs(pct) > 0.5;
  const adminDollars = value * (item.adminPct / 100);
  const frontlineDollars = value - adminDollars;
  const isProtected = PROTECTED_IDS.has(item.id);
  const sliderMin = isProtected ? item.baseline : 0;
  const sliderMax = item.baseline * 1.25;
  const sliderStep = item.baseline * 0.025;
  const fillPct = sliderMax > sliderMin ? ((value - sliderMin) / (sliderMax - sliderMin)) * 100 : 0;
  return (
    <div style={{ padding: "10px 0", borderBottom: "1px solid rgba(255,255,255,0.05)", transition: "background 0.15s ease" }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8, minWidth: 0, flex: 1 }}>
          <div style={{ width: 8, height: 8, borderRadius: 2, background: item.color, flexShrink: 0 }} />
          <span style={{ fontSize: T.body, fontWeight: 500, color: "#ccc", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{item.name}</span>
          {isProtected && <span style={{ fontSize: T.micro, color: "#4ade80", fontWeight: 600, letterSpacing: 0.5 }} title="Protected from cuts">&#x1F6E1;&#xFE0F;</span>}
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 8, flexShrink: 0 }}>
          <span style={{ fontSize: T.h3, fontWeight: 700, color: "#ddd", fontVariantNumeric: "tabular-nums" }}>{f(value)}</span>
          {changed && <span style={{ fontSize: T.micro, fontWeight: 700, padding: "2px 6px", borderRadius: 3, background: pct > 0 ? "rgba(248,113,113,0.15)" : "rgba(74,222,128,0.15)", color: pct > 0 ? "#f87171" : "#4ade80" }}>{pct > 0 ? "+" : ""}{pct.toFixed(0)}%</span>}
        </div>
      </div>
      <input type="range" min={sliderMin} max={sliderMax} step={sliderStep} value={value} onChange={e => onChange(item.id, parseFloat(e.target.value))}
        style={{ width: "100%", height: 4, appearance: "none", WebkitAppearance: "none", background: `linear-gradient(to right, ${item.color}88 0%, ${item.color}88 ${fillPct}%, rgba(255,255,255,0.05) ${fillPct}%, rgba(255,255,255,0.05) 100%)`, borderRadius: 2, outline: "none", cursor: "pointer" }} />
      {item.adminPct > 0 && (
        <div style={{ display: "flex", gap: 1, marginTop: 5, height: 4, borderRadius: 2, overflow: "hidden", opacity: 0.5 }}>
          <div style={{ width: `${100 - item.adminPct}%`, background: "#4ade80", transition: "width 0.3s ease" }} title={`Frontline: ${f(frontlineDollars)}`} />
          <div style={{ width: `${item.adminPct}%`, background: "#f87171", transition: "width 0.3s ease" }} title={`Admin: ${f(adminDollars)}`} />
        </div>
      )}
      <div style={{ fontSize: T.caption, color: "#666", marginTop: 4, display: "flex", justifyContent: "space-between", lineHeight: 1.4 }}>
        <span>{item.desc}</span>
        {item.adminPct > 0 && <span style={{ flexShrink: 0, marginLeft: 10, color: "#777", fontWeight: 500 }}>{item.adminPct}% admin</span>}
      </div>
    </div>
  );
}

function Metric({ label, value, sub, color }) {
  return (
    <div>
      <div style={{ fontSize: T.micro, color: "#777", textTransform: "uppercase", letterSpacing: 1.5, fontWeight: 600, marginBottom: 2 }}>{label}</div>
      <div style={{ fontSize: T.h2, fontWeight: 700, color: color || "#ddd", fontVariantNumeric: "tabular-nums", letterSpacing: "-0.01em" }}>{value}</div>
      {sub && <div style={{ fontSize: T.caption, color: "#666", marginTop: 1 }}>{sub}</div>}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════
// MAIN APP
// ═══════════════════════════════════════════════════════════════
function BCBudgetV2() {
  const [brackets, setBrackets] = useState(DEFAULT_BRACKETS);
  const [corpRate, setCorpRate] = useState(DEFAULT_CORP_RATE);
  const [expenses, setExpenses] = useState(Object.fromEntries(EXPENSE_ITEMS.map(i => [i.id, i.baseline])));
  const [revenues, setRevenues] = useState(Object.fromEntries(REVENUE_ITEMS.map(i => [i.id, i.baseline])));
  const [tab, setTab] = useState("overview");
  const [expandedSectors, setExpandedSectors] = useState(new Set());

  const updateBracketRate = useCallback((id, newRate) => {
    setBrackets(prev => prev.map(b => b.id === id ? { ...b, rate: newRate } : b));
    setActivePreset(null);
  }, []);

  const handleExpense = useCallback((id, val) => { setExpenses(p => ({ ...p, [id]: val })); setActivePreset(null); }, []);
  const handleRevenue = useCallback((id, val) => { setRevenues(p => ({ ...p, [id]: val })); setActivePreset(null); }, []);

  // PIT scales with bracket changes
  const pitMultiplier = useMemo(() => estimatePITRevenue(brackets) / baselinePIT, [brackets]);
  const corpMultiplier = corpRate / DEFAULT_CORP_RATE;

  const effectiveRevenues = useMemo(() => ({
    ...revenues,
    pit: revenues.pit * pitMultiplier,
    cit: revenues.cit * corpMultiplier,
  }), [revenues, pitMultiplier, corpMultiplier]);

  const totalRevenue = useMemo(() => Object.values(effectiveRevenues).reduce((a, b) => a + b, 0), [effectiveRevenues]);
  const totalExpense = useMemo(() => Object.values(expenses).reduce((a, b) => a + b, 0), [expenses]);
  const deficit = totalRevenue - totalExpense;
  const baselineDeficit = -13.3;
  const change = deficit - baselineDeficit;

  const totalAdmin = useMemo(() => EXPENSE_ITEMS.reduce((sum, item) => sum + expenses[item.id] * (item.adminPct / 100), 0), [expenses]);
  const totalFrontline = totalExpense - totalAdmin;

  const sectorTotals = useMemo(() => {
    const m = {};
    SECTORS.forEach(s => { m[s.id] = { total: 0, admin: 0, frontline: 0, items: [] }; });
    EXPENSE_ITEMS.forEach(item => {
      const val = expenses[item.id];
      const adm = val * (item.adminPct / 100);
      if (m[item.sector]) {
        m[item.sector].total += val;
        m[item.sector].admin += adm;
        m[item.sector].frontline += val - adm;
        m[item.sector].items.push(item);
      }
    });
    return m;
  }, [expenses]);

  const toggleSector = (id) => setExpandedSectors(prev => {
    const n = new Set(prev);
    n.has(id) ? n.delete(id) : n.add(id);
    return n;
  });

  const [activePreset, setActivePreset] = useState("reset");

  const resetAll = () => {
    setBrackets(DEFAULT_BRACKETS);
    setCorpRate(DEFAULT_CORP_RATE);
    setExpenses(Object.fromEntries(EXPENSE_ITEMS.map(i => [i.id, i.baseline])));
    setRevenues(Object.fromEntries(REVENUE_ITEMS.map(i => [i.id, i.baseline])));
  };

  const applyPreset = (preset) => {
    // Always reset to baseline first so presets are exclusive, not additive
    resetAll();
    setActivePreset(preset);

    // Helper: apply expense multiplier but respect protected item floors
    const safeSet = (newExp, id, val) => {
      const floor = PROTECTED_IDS.has(id) ? EXPENSE_ITEMS.find(i => i.id === id).baseline : 0;
      newExp[id] = Math.max(val, floor);
    };

    if (preset === "reset") {
      // Already reset above
    } else if (preset === "admin_1975") {
      const newExp = Object.fromEntries(EXPENSE_ITEMS.map(i => [i.id, i.baseline]));
      EXPENSE_ITEMS.forEach(item => {
        if (item.adminPct >= 80) safeSet(newExp, item.id, item.baseline * 0.3);
        else if (item.adminPct >= 30) safeSet(newExp, item.id, item.baseline * 0.85);
      });
      setExpenses(newExp);
    } else if (preset === "admin_ai") {
      const newExp = Object.fromEntries(EXPENSE_ITEMS.map(i => [i.id, i.baseline]));
      EXPENSE_ITEMS.forEach(item => {
        if (item.adminPct >= 85) safeSet(newExp, item.id, item.baseline * 0.15);
        else if (item.adminPct >= 40) safeSet(newExp, item.id, item.baseline * 0.6);
        else if (item.adminPct >= 20) safeSet(newExp, item.id, item.baseline * 0.9);
      });
      setExpenses(newExp);
    } else if (preset === "my_budget") {
      const newExp = Object.fromEntries(EXPENSE_ITEMS.map(i => [i.id, i.baseline]));
      EXPENSE_ITEMS.forEach(item => {
        if (item.adminPct >= 85) safeSet(newExp, item.id, item.baseline * 0.15);
        else if (item.adminPct >= 40) safeSet(newExp, item.id, item.baseline * 0.6);
        else if (item.adminPct >= 20) safeSet(newExp, item.id, item.baseline * 0.9);
      });
      setExpenses(newExp);
      setBrackets(DEFAULT_BRACKETS.map(b => {
        if (b.id === "b1") return { ...b, rate: 4.50 };
        if (b.id === "b2") return { ...b, rate: 7.00 };
        if (b.id === "b3") return { ...b, rate: 9.50 };
        if (b.id === "b4") return { ...b, rate: 11.29 };
        if (b.id === "b5") return { ...b, rate: 13.70 };
        if (b.id === "b6") return { ...b, rate: 15.80 };
        if (b.id === "b7") return { ...b, rate: 19.50 };
        return b;
      }));
      setCorpRate(15.0);
      setRevenues(Object.fromEntries(REVENUE_ITEMS.map(i => [i.id, i.baseline])));
      setRevenues(prev => ({ ...prev, pst: 10.2 * (5.0 / 7.0) }));
    }
  };

  const tabs = [
    { id: "overview", label: "\u{1F4CA} Overview" },
    { id: "taxes", label: "\u{1F4B0} Tax Brackets" },
    { id: "spending", label: "\u{1F3DB}\uFE0F Spending" },
    { id: "admin", label: "\u{1F52C} Admin Analysis" },
  ];

  return (
    <div style={{ fontFamily: "'IBM Plex Sans', -apple-system, sans-serif", background: "linear-gradient(150deg, #080a0f 0%, #0f1319 40%, #0a0e14 100%)", color: "#e0e0e0", minHeight: "100vh" }}>

      {/* ═══ HERO ═══ */}
      <div className="page-gutter" style={{ paddingTop: 32, paddingBottom: 28, textAlign: "center", position: "relative", overflow: "hidden" }}>
        {/* Glow behind the number */}
        <div style={{ position: "absolute", top: "50%", left: "50%", transform: "translate(-50%, -40%)", width: 400, height: 400, background: `radial-gradient(circle, ${deficit >= 0 ? "rgba(46,204,113,0.07)" : "rgba(231,76,60,0.06)"} 0%, transparent 65%)`, pointerEvents: "none", transition: "background 0.5s ease" }} />

        <div style={{ fontSize: T.micro, letterSpacing: 3, color: "#6a6e78", textTransform: "uppercase", fontWeight: 600, marginBottom: 8, position: "relative" }}>BC Budget 2026</div>

        <div className="hero-number" style={{ fontSize: 64, fontWeight: 800, color: deficit >= 0 ? "#2ecc71" : "#ff6b6b", letterSpacing: "-0.03em", lineHeight: 1, position: "relative", fontVariantNumeric: "tabular-nums", transition: "color 0.3s ease" }}>
          {deficit >= 0 ? "+" : "-"}{f(Math.abs(deficit))}
        </div>
        <div style={{ fontSize: T.body, color: "#888", marginTop: 6, position: "relative" }}>
          {deficit >= 0 ? "Surplus" : "Deficit"}
          {change !== 0 && (<span style={{ color: change > 0 ? "#4ade80" : "#f87171", fontWeight: 600 }}> &middot; {f(Math.abs(change))} {change > 0 ? "better" : "worse"} than baseline</span>)}
        </div>

        {/* Compact metrics */}
        <div className="metrics-row" style={{ marginTop: 20, position: "relative" }}>
          <Metric label="Revenue" value={f(totalRevenue)} color="#4ade80" />
          <div style={{ width: 1, background: "rgba(255,255,255,0.10)", alignSelf: "stretch", margin: "4px 0" }} />
          <Metric label="Spending" value={f(totalExpense)} color="#f87171" />
          <div style={{ width: 1, background: "rgba(255,255,255,0.10)", alignSelf: "stretch", margin: "4px 0" }} />
          <Metric label="Frontline" value={`${(totalFrontline/totalExpense*100).toFixed(0)}%`} sub={f(totalFrontline)} />
          <div style={{ width: 1, background: "rgba(255,255,255,0.10)", alignSelf: "stretch", margin: "4px 0" }} />
          <Metric label="Admin" value={`${(totalAdmin/totalExpense*100).toFixed(0)}%`} sub={f(totalAdmin)} color={(totalAdmin/totalExpense) > 0.22 ? "#f59e0b" : "#666"} />
        </div>
      </div>

      {/* ═══ PRESETS — compact pills ═══ */}
      <div className="page-gutter" style={{ paddingTop: 0, paddingBottom: 12, borderBottom: "1px solid rgba(255,255,255,0.06)" }}>
        <div className="preset-row">
          {[
            ["reset", "\u21BA", "2026 Budget", "#7f8c8d"],
            ["my_budget", "\u{1F4A1}", "Proposed Budget", "#3498db"],
            ["admin_1975", "\u{1F4C9}", "1975 Admin", "#e67e22"],
            ["admin_ai", "\u{1F916}", "AI Admin", "#2ecc71"],
          ].map(([k, icon, label, color]) => {
            const isActive = activePreset === k;
            return (
              <button key={k} onClick={() => applyPreset(k)} style={{
                padding: "6px 16px",
                background: isActive ? `${color}18` : "transparent",
                border: `1.5px solid ${isActive ? color + "66" : "rgba(255,255,255,0.12)"}`,
                borderRadius: 20,
                color: isActive ? "#fff" : "#999",
                cursor: "pointer",
                whiteSpace: "nowrap",
                fontSize: T.body,
                fontWeight: isActive ? 700 : 500,
                letterSpacing: "0.01em",
              }}>{icon} {label}</button>
            );
          })}
        </div>
      </div>

      {/* ═══ TABS — underline style ═══ */}
      <div className="tab-bar" style={{ borderBottom: "1px solid rgba(255,255,255,0.08)", paddingTop: 0, background: "rgba(255,255,255,0.02)" }}>
        {tabs.map(t => {
          const active = tab === t.id;
          return (
            <button key={t.id} onClick={() => setTab(t.id)} style={{
              padding: "12px 18px",
              background: active ? "rgba(255,255,255,0.04)" : "none",
              border: "none",
              borderBottom: active ? "2px solid #5ba8e0" : "2px solid transparent",
              color: active ? "#fff" : "#888",
              fontSize: T.body,
              fontWeight: active ? 700 : 500,
              cursor: "pointer",
              whiteSpace: "nowrap",
              letterSpacing: "0.01em",
              marginBottom: -1,
            }}>{t.label}</button>
          );
        })}
      </div>

      {/* ═══ CONTENT ═══ */}
      <div className="content-area">

        {/* OVERVIEW TAB */}
        {tab === "overview" && (
          <div>
            {/* Sector bar */}
            <div style={{ marginBottom: 24 }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
                <span style={{ fontSize: T.caption, color: "#888", fontWeight: 700, letterSpacing: 1, textTransform: "uppercase" }}>Expenses by Sector</span>
                <span style={{ fontSize: T.body, color: "#fff", fontWeight: 700 }}>{f(totalExpense)}</span>
              </div>
              <div style={{ display: "flex", height: 32, borderRadius: 8, overflow: "hidden", gap: 1, boxShadow: "0 2px 8px rgba(0,0,0,0.2)" }}>
                {SECTORS.map(s => {
                  const pct = (sectorTotals[s.id].total / totalExpense) * 100;
                  if (pct < 0.3) return null;
                  return <div key={s.id} title={`${s.name}: ${f(sectorTotals[s.id].total)} (${pct.toFixed(1)}%)`} style={{ width: `${pct}%`, background: s.color, opacity: 0.8, cursor: "pointer", transition: "opacity 0.15s ease" }} onMouseEnter={e => e.target.style.opacity = 1} onMouseLeave={e => e.target.style.opacity = 0.8} />;
                })}
              </div>
              <div style={{ display: "flex", flexWrap: "wrap", gap: "6px 16px", marginTop: 10 }}>
                {SECTORS.map(s => {
                  const t = sectorTotals[s.id].total;
                  if (t < 0.1) return null;
                  return <span key={s.id} style={{ fontSize: T.caption, color: "#999" }}><span style={{ color: s.color, marginRight: 3 }}>{"\u25CF"}</span>{s.name}: {f(t)}</span>;
                })}
              </div>
            </div>

            {/* Admin vs Frontline bar */}
            <div style={{ marginBottom: 24 }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}>
                <span style={{ fontSize: T.caption, color: "#888", fontWeight: 600 }}>Frontline vs Admin Split</span>
                <span style={{ fontSize: T.caption, color: "#888" }}>{f(totalFrontline)} frontline &middot; {f(totalAdmin)} admin</span>
              </div>
              <div style={{ display: "flex", height: 24, borderRadius: 6, overflow: "hidden", gap: 2 }}>
                <div style={{ width: `${(totalFrontline/totalExpense)*100}%`, background: "linear-gradient(135deg, #2ecc71, #27ae60)", transition: "width 0.3s", display: "flex", alignItems: "center", justifyContent: "center" }}>
                  <span style={{ fontSize: T.caption, fontWeight: 700, color: "rgba(255,255,255,0.85)" }}>{(totalFrontline/totalExpense*100).toFixed(0)}%</span>
                </div>
                <div style={{ width: `${(totalAdmin/totalExpense)*100}%`, background: "linear-gradient(135deg, #e74c3c, #c0392b)", transition: "width 0.3s", display: "flex", alignItems: "center", justifyContent: "center" }}>
                  <span style={{ fontSize: T.caption, fontWeight: 700, color: "rgba(255,255,255,0.85)" }}>{(totalAdmin/totalExpense*100).toFixed(0)}%</span>
                </div>
              </div>
            </div>

            {/* Sector summaries */}
            {SECTORS.map(sector => {
              const st = sectorTotals[sector.id];
              if (st.total < 0.05) return null;
              const adminPct = st.total > 0 ? (st.admin / st.total * 100) : 0;
              const isOpen = expandedSectors.has(sector.id);
              return (
                <div key={sector.id} style={{ borderBottom: "1px solid rgba(255,255,255,0.06)", background: isOpen ? "rgba(255,255,255,0.015)" : "transparent", borderRadius: isOpen ? 8 : 0, transition: "background 0.15s ease" }}>
                  <div onClick={() => toggleSector(sector.id)} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "14px 8px", cursor: "pointer", borderRadius: 6 }} onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.035)"} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                    <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                      <span style={{ fontSize: 16 }}>{sector.icon}</span>
                      <span style={{ fontSize: T.h3, fontWeight: 700, color: "#eee" }}>{sector.name}</span>
                      <span style={{ fontSize: T.body, color: "#888", fontWeight: 600, fontVariantNumeric: "tabular-nums" }}>{f(st.total)}</span>
                    </div>
                    <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                      {adminPct > 0 && <span style={{ fontSize: T.caption, color: adminPct > 25 ? "#f87171" : "#777", fontWeight: 500 }}>{adminPct.toFixed(0)}% admin</span>}
                      <span style={{ color: "#777", fontSize: T.body, transition: "transform 0.2s ease", transform: isOpen ? "rotate(0deg)" : "rotate(-90deg)", display: "inline-block" }}>{"\u25BE"}</span>
                    </div>
                  </div>
                  {isOpen && (
                    <div style={{ padding: "0 8px 12px" }}>
                      {st.items.map(item => (
                        <ExpenseSlider key={item.id} item={item} value={expenses[item.id]} onChange={handleExpense} />
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {/* TAX BRACKETS TAB */}
        {tab === "taxes" && (
          <div>
            <div style={{ fontSize: T.body, color: "#999", marginBottom: 20, lineHeight: 1.6 }}>
              Edit each bracket's tax rate to model alternative approaches. The PIT revenue estimate updates in real-time.
              The government raised only the lowest bracket from 5.06% {"\u2192"} 5.60% while leaving all others untouched.
              Try the "{"\u{1F4A1}"} Proposed Budget" preset to see an alternative: lower all personal brackets, raise corporate tax, drop PST to 5%, and slash admin overhead with AI.
            </div>

            {/* Corporate Rate */}
            <div style={{ background: "rgba(255,255,255,0.02)", borderRadius: 10, padding: 18, marginBottom: 20 }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                <span style={{ fontSize: T.h3, fontWeight: 700, color: "#e67e22" }}>{"\u{1F3E2}"} Corporate Income Tax Rate</span>
                <span style={{ fontSize: T.h2, fontWeight: 800, color: "#ddd" }}>{corpRate.toFixed(1)}%</span>
              </div>
              <MiniSlider value={corpRate} onChange={v => { setCorpRate(v); setActivePreset(null); }} min={8} max={20} step={0.5} color="#e67e22" format={v => `${v.toFixed(1)}%`} />
              <div style={{ display: "flex", justifyContent: "space-between", fontSize: T.body, color: "#888", marginTop: 6 }}>
                <span>Baseline: 12.0% (general rate)</span>
                <span>Est. Revenue: {f(effectiveRevenues.cit)} {corpRate !== DEFAULT_CORP_RATE && <span style={{ color: corpMultiplier > 1 ? "#2ecc71" : "#e74c3c" }}>({corpMultiplier > 1 ? "+" : ""}{((corpMultiplier - 1) * 100).toFixed(0)}%)</span>}</span>
              </div>
            </div>

            {/* Personal Brackets */}
            <div style={{ background: "rgba(255,255,255,0.02)", borderRadius: 10, padding: 18 }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
                <span style={{ fontSize: T.h3, fontWeight: 700, color: "#e74c3c" }}>{"\u{1F464}"} Personal Income Tax Brackets</span>
                <span style={{ fontSize: T.body, color: "#888" }}>Est. PIT Revenue: <span style={{ color: "#fff", fontWeight: 700 }}>{f(effectiveRevenues.pit)}</span></span>
              </div>

              {brackets.map((b) => {
                const changed = Math.abs(b.rate - b.oldRate) > 0.01;
                const isGovChanged = Math.abs(DEFAULT_BRACKETS.find(d => d.id === b.id).rate - b.oldRate) > 0.01;
                return (
                  <div key={b.id} style={{
                    padding: "12px 14px", marginBottom: 8, borderRadius: 8,
                    background: changed ? "rgba(255,255,255,0.04)" : "rgba(255,255,255,0.015)",
                    border: `1px solid ${isGovChanged && b.rate === DEFAULT_BRACKETS.find(d => d.id === b.id).rate ? "rgba(231,76,60,0.3)" : changed ? "rgba(255,255,255,0.1)" : "rgba(255,255,255,0.04)"}`,
                    transition: "background 0.15s ease",
                  }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                      <div>
                        <span style={{ fontSize: T.body, fontWeight: 700, color: "#ddd" }}>{b.label}</span>
                        <span style={{ fontSize: T.body, color: "#888", marginLeft: 10 }}>{b.range}</span>
                      </div>
                      <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                        <span style={{ fontSize: T.caption, color: "#888" }}>Pre-2026: {b.oldRate}%</span>
                        <span style={{ fontSize: T.caption, color: "#666" }}>{"\u2192"}</span>
                        <input type="number" value={b.rate} step={0.1} min={0} max={40}
                          onChange={e => updateBracketRate(b.id, parseFloat(e.target.value) || 0)}
                          style={{ width: 62 }} />
                        <span style={{ fontSize: T.body, color: "#888" }}>%</span>
                      </div>
                    </div>
                    <MiniSlider value={b.rate} onChange={(v) => updateBracketRate(b.id, v)} min={0} max={30} step={0.1} color={changed ? "#e74c3c" : "#3498db"} format={v => `${v.toFixed(2)}%`} />
                    <div style={{ display: "flex", justifyContent: "space-between", fontSize: T.caption, color: "#777", marginTop: 4 }}>
                      <span>~{(b.population / 1000).toFixed(0)}K taxpayers in bracket</span>
                      {changed && <span style={{ color: b.rate > b.oldRate ? "#e74c3c" : "#2ecc71", fontWeight: 600 }}>
                        {b.rate > b.oldRate ? "\u2191" : "\u2193"} {Math.abs(b.rate - b.oldRate).toFixed(2)}pp change
                      </span>}
                    </div>
                  </div>
                );
              })}

              <div style={{ marginTop: 16, padding: "14px 16px", background: "rgba(231,76,60,0.04)", borderRadius: 10, fontSize: T.body, color: "#bbb", lineHeight: 1.6 }}>
                <strong style={{ color: "#e74c3c" }}>The fairness problem:</strong> The 2026 budget raised only the 1st bracket (affecting ~1.68M low/middle income taxpayers)
                by 0.54pp. The top bracket (20.5% on $252K+, ~75K taxpayers) was untouched. The tax reduction credit
                only offsets this for those under ~$45K &mdash; leaving the $45K&ndash;$95K middle class bearing the full weight.
                Additionally, bracket indexing is frozen 2027&ndash;2030, meaning inflation will silently push everyone into higher
                effective rates. This is a regressive approach that shifts the burden downward.
              </div>
            </div>
          </div>
        )}

        {/* SPENDING TAB */}
        {tab === "spending" && (
          <div>
            <div style={{ fontSize: T.body, color: "#999", marginBottom: 16, lineHeight: 1.6 }}>
              Granular spending controls by sector. The green/red bar under each item shows the frontline vs admin split.
              Click sector headers to expand. Debt servicing ($6.5B) is non-discretionary.
            </div>
            {/* Revenue mini-controls */}
            <details open style={{ marginBottom: 16 }}>
              <summary style={{ fontSize: T.body, fontWeight: 700, color: "#aaa", cursor: "pointer", marginBottom: 10, letterSpacing: "0.01em" }}>{"\u{1F4C8}"} Revenue Adjustments</summary>
              <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(300px, 1fr))", gap: 6 }}>
                {REVENUE_ITEMS.filter(i => i.id !== "pit" && i.id !== "cit").map(item => {
                  const revPct = ((revenues[item.id] - item.baseline) / item.baseline) * 100;
                  const revChanged = Math.abs(revPct) > 0.5;
                  const pstRate = item.id === "pst" ? (revenues[item.id] / item.baseline * 7).toFixed(1) : null;
                  return (
                    <div key={item.id} style={{ padding: "8px 12px", background: "rgba(255,255,255,0.02)", borderRadius: 8 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", fontSize: T.body, marginBottom: 4 }}>
                        <span style={{ color: "#aaa" }}>
                          <span style={{ color: item.color, marginRight: 4 }}>{"\u25CF"}</span>
                          {item.name}
                          {pstRate && <span style={{ color: "#f1c40f", fontWeight: 700, marginLeft: 6 }}>{pstRate}%</span>}
                        </span>
                        <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
                          {revChanged && <span style={{ fontSize: T.micro, fontWeight: 700, padding: "1px 5px", borderRadius: 3, background: revPct > 0 ? "rgba(74,222,128,0.15)" : "rgba(248,113,113,0.15)", color: revPct > 0 ? "#4ade80" : "#f87171" }}>{revPct > 0 ? "+" : ""}{revPct.toFixed(0)}%</span>}
                          <span style={{ color: "#fff", fontWeight: 600, fontVariantNumeric: "tabular-nums" }}>{f(revenues[item.id])}</span>
                        </span>
                      </div>
                      <input type="range" min={0} max={item.baseline * 2} step={0.1} value={revenues[item.id]} onChange={e => handleRevenue(item.id, parseFloat(e.target.value))}
                        style={{ width: "100%", height: 4, appearance: "none", WebkitAppearance: "none", background: `linear-gradient(to right, ${item.color} 0%, ${item.color} ${(revenues[item.id] / (item.baseline * 2)) * 100}%, rgba(255,255,255,0.06) ${(revenues[item.id] / (item.baseline * 2)) * 100}%, rgba(255,255,255,0.06) 100%)`, borderRadius: 3, outline: "none", cursor: "pointer" }} />
                    </div>
                  );
                })}
              </div>
            </details>

            {SECTORS.map(sector => {
              const st = sectorTotals[sector.id];
              if (st.total < 0.05) return null;
              const isOpen = expandedSectors.has(sector.id);
              return (
                <div key={sector.id} style={{ borderBottom: "1px solid rgba(255,255,255,0.06)", background: isOpen ? "rgba(255,255,255,0.015)" : "transparent", borderRadius: isOpen ? 8 : 0, transition: "background 0.15s ease" }}>
                  <div onClick={() => toggleSector(sector.id)} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "14px 8px", cursor: "pointer", borderRadius: 6 }} onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.035)"} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                    <span style={{ fontSize: T.h3, fontWeight: 700, color: "#eee" }}>{sector.icon} {sector.name} &mdash; {f(st.total)}</span>
                    <span style={{ color: "#777", fontSize: T.body, transition: "transform 0.2s ease", transform: isOpen ? "rotate(0deg)" : "rotate(-90deg)", display: "inline-block" }}>{"\u25BE"}</span>
                  </div>
                  {isOpen && (
                    <div style={{ padding: "0 8px 12px" }}>
                      {st.items.map(item => <ExpenseSlider key={item.id} item={item} value={expenses[item.id]} onChange={handleExpense} />)}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {/* ADMIN ANALYSIS TAB */}
        {tab === "admin" && (
          <div>
            <div style={{ fontSize: T.body, color: "#999", marginBottom: 20, lineHeight: 1.7 }}>
              Administrative overhead has grown dramatically over the past 50 years while frontline service delivery has stagnated.
              BC health authorities have seen corporate expenditures outpace healthcare delivery investments. Education admin
              (3,080 FTE) grew by 339 positions since 2016-17 even as overall enrollment shifted. Canada spends ~17% of healthcare
              dollars on administration vs ~8% in the 1970s. With AI automating scheduling, billing, compliance, reporting, HR, and
              management tasks, we can radically reduce this overhead.
            </div>

            {/* Historical admin trend */}
            <div style={{ background: "rgba(255,255,255,0.02)", borderRadius: 12, padding: 20, marginBottom: 20 }}>
              <h3 style={{ fontSize: T.h3, fontWeight: 700, color: "#ddd", marginBottom: 14 }}>{"\u{1F4C8}"} Admin Overhead Growth: 1975 {"\u2192"} 2026</h3>
              <div style={{ display: "flex", alignItems: "flex-end", gap: 3, height: 160, padding: "0 6px" }}>
                {ADMIN_HISTORY.map((h, i) => (
                  <div key={i} style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 3 }}>
                    <div style={{ display: "flex", gap: 2, alignItems: "flex-end", height: 130, width: "100%" }}>
                      <div style={{ flex: 1, background: "linear-gradient(to top, #e74c3c, #e74c3cbb)", borderRadius: "4px 4px 0 0", height: `${(h.healthAdminPct / 25) * 100}%`, transition: "height 0.3s" }} title={`Health admin: ${h.healthAdminPct}%`} />
                      <div style={{ flex: 1, background: "linear-gradient(to top, #e67e22, #e67e22bb)", borderRadius: "4px 4px 0 0", height: `${(h.eduAdminPct / 25) * 100}%`, transition: "height 0.3s" }} title={`Edu admin: ${h.eduAdminPct}%`} />
                    </div>
                    <span style={{ fontSize: T.micro, color: "#666", whiteSpace: "nowrap", fontWeight: 500 }}>{h.year}</span>
                  </div>
                ))}
              </div>
              <div style={{ display: "flex", gap: 20, justifyContent: "center", marginTop: 12 }}>
                <span style={{ fontSize: T.caption, color: "#e74c3c", fontWeight: 500 }}>{"\u{1F534}"} Health Admin %</span>
                <span style={{ fontSize: T.caption, color: "#e67e22", fontWeight: 500 }}>{"\u{1F7E0}"} Education Admin %</span>
              </div>
            </div>

            {/* Per-sector admin breakdown */}
            <div style={{ background: "rgba(255,255,255,0.02)", borderRadius: 12, padding: 20, marginBottom: 20 }}>
              <h3 style={{ fontSize: T.h3, fontWeight: 700, color: "#ddd", marginBottom: 14 }}>{"\u{1F3DB}\uFE0F"} Admin Dollars by Sector (Your Scenario)</h3>
              {SECTORS.filter(s => sectorTotals[s.id].admin > 0.05).map(s => {
                const st = sectorTotals[s.id];
                const adminPct = st.total > 0 ? (st.admin / st.total * 100) : 0;
                return (
                  <div key={s.id} style={{ marginBottom: 10 }}>
                    <div style={{ display: "flex", justifyContent: "space-between", fontSize: T.body, marginBottom: 4 }}>
                      <span style={{ color: "#bbb", fontWeight: 500 }}>{s.icon} {s.name}</span>
                      <span style={{ color: "#888", fontVariantNumeric: "tabular-nums" }}>{f(st.admin)} admin / {f(st.total)} total ({adminPct.toFixed(0)}%)</span>
                    </div>
                    <div style={{ display: "flex", height: 16, borderRadius: 4, overflow: "hidden", gap: 1, boxShadow: "0 1px 4px rgba(0,0,0,0.15)" }}>
                      <div style={{ width: `${100 - adminPct}%`, background: "#2ecc71", opacity: 0.6, transition: "width 0.3s ease" }} />
                      <div style={{ width: `${adminPct}%`, background: "#e74c3c", opacity: 0.6, transition: "width 0.3s ease" }} />
                    </div>
                  </div>
                );
              })}
              <div style={{ marginTop: 14, padding: "12px 16px", background: "rgba(52,152,219,0.05)", borderRadius: 10, fontSize: T.body, color: "#bbb", lineHeight: 1.6 }}>
                <strong style={{ color: "#3498db" }}>Total admin spend: {f(totalAdmin)}</strong> ({(totalAdmin/totalExpense*100).toFixed(1)}% of all spending).
                Cutting admin to 1975 levels (~8% of health, ~6% of education) would save an estimated
                <strong style={{ color: "#2ecc71" }}> {f(totalAdmin * 0.5)}</strong> &mdash; roughly {((totalAdmin * 0.5 / 13.3) * 100).toFixed(0)}% of the current deficit.
              </div>
            </div>

            {/* Key admin items */}
            <div style={{ background: "rgba(255,255,255,0.02)", borderRadius: 12, padding: 20, marginBottom: 20 }}>
              <h3 style={{ fontSize: T.h3, fontWeight: 700, color: "#ddd", marginBottom: 12 }}>{"\u{1F3AF}"} Largest Admin-Heavy Line Items</h3>
              {EXPENSE_ITEMS.filter(i => i.adminPct >= 40).sort((a, b) => expenses[b.id] * b.adminPct - expenses[a.id] * a.adminPct).map(item => {
                const val = expenses[item.id];
                const adminDollars = val * (item.adminPct / 100);
                const baselineAdmin = item.baseline * (item.adminPct / 100);
                const saved = baselineAdmin - adminDollars;
                return (
                  <div key={item.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "8px 0", borderBottom: "1px solid rgba(255,255,255,0.04)", fontSize: T.body }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 8, flex: 1, minWidth: 0 }}>
                      <div style={{ width: 8, height: 8, borderRadius: 2, background: item.color, flexShrink: 0, boxShadow: `0 0 4px ${item.color}44` }} />
                      <span style={{ color: "#bbb", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{item.name}</span>
                    </div>
                    <div style={{ display: "flex", gap: 14, alignItems: "center", flexShrink: 0 }}>
                      <span style={{ color: "#e74c3c", fontWeight: 500 }}>{item.adminPct}% admin</span>
                      <span style={{ color: "#fff", fontWeight: 600, fontVariantNumeric: "tabular-nums" }}>{f(adminDollars)}</span>
                      {saved > 0.05 && <span style={{ color: "#2ecc71", fontWeight: 600 }}>saved {f(saved)}</span>}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* The AI argument */}
            <div style={{ background: "rgba(46,204,113,0.04)", borderRadius: 12, padding: 20, marginBottom: 20 }}>
              <h3 style={{ fontSize: T.h3, fontWeight: 700, color: "#2ecc71", marginBottom: 10 }}>{"\u{1F916}"} The AI Administration Argument</h3>
              <div style={{ fontSize: T.body, color: "#bbb", lineHeight: 1.7 }}>
                <p style={{ margin: "0 0 10px" }}>
                  Modern AI can automate the majority of administrative tasks that have driven overhead growth since the 1970s:
                </p>
                <div className="ai-grid" style={{ marginBottom: 14 }}>
                  {[
                    ["Scheduling & Coordination", "AI scheduling systems can replace entire admin teams managing appointments, shifts, and resource allocation."],
                    ["Billing & Claims Processing", "Automated processing of health claims, school funding formulas, and grant management."],
                    ["Compliance & Reporting", "AI-generated compliance reports, audits, and regulatory filings that currently require floors of analysts."],
                    ["HR & People Management", "Automated payroll, benefits admin, performance tracking. Middle management layers become redundant."],
                    ["Procurement & Contracts", "AI-driven procurement eliminates the need for large purchasing departments and contract managers."],
                    ["Data & Decision Support", "Real-time dashboards replace monthly reports from teams of data analysts and business intelligence staff."],
                  ].map(([title, desc], i) => (
                    <div key={i} style={{ padding: "10px 12px", background: "rgba(255,255,255,0.03)", borderRadius: 8, border: "1px solid rgba(255,255,255,0.05)" }}>
                      <div style={{ fontSize: T.body, fontWeight: 700, color: "#2ecc71", marginBottom: 4 }}>{"\u2713"} {title}</div>
                      <div style={{ fontSize: T.caption, color: "#888", lineHeight: 1.5 }}>{desc}</div>
                    </div>
                  ))}
                </div>
                <p style={{ margin: "0 0 10px" }}>
                  <strong>BC Education:</strong> 3,080 FTE administrators manage 37,000 teachers &mdash; that's 1 admin per 12 teachers.
                  In 1975 it was closer to 1 per 25. Going back to 1975 ratios would eliminate ~1,500 admin positions.
                  With AI? 1 per 50+ is achievable, freeing ~2,400 positions worth of salary for frontline teaching.
                </p>
                <p style={{ margin: "0 0 10px" }}>
                  <strong>BC Health:</strong> Corporate expenditures have increased in every BC health authority, outpacing healthcare delivery
                  investments. The CST IT project alone ballooned to $799M (Ontario did similar for half the cost). Fraser Health
                  overran its budget by $1.1B (20%) in a single year. AI can't fix all of this, but automating the administrative
                  machinery that creates and manages this complexity is a multi-billion dollar opportunity.
                </p>
                <p style={{ margin: 0, fontWeight: 600, color: "#2ecc71" }}>
                  Try the "{"\u{1F916}"} AI Admin" preset above to see the fiscal impact of an aggressive admin reduction scenario.
                </p>
              </div>
            </div>

            <div style={{ fontSize: T.body, color: "#666", lineHeight: 1.6, padding: 16, background: "rgba(255,255,255,0.02)", borderRadius: 10 }}>
              <strong>Data sources:</strong> BC Budget 2026 fiscal plan, CIHI National Health Expenditure Trends 2024,
              BC Education by the Numbers (Dec 2025: 37,000 FTE teachers, 3,080 FTE administrators),
              Fraser Institute Education Spending in Public Schools 2025, PwC/MNP/RBC/TD Economics budget analyses.
              Admin percentages are estimates based on CIHI data showing Canada at ~17% health admin nationally,
              and education administration research. Historical trend data derived from CIHI longitudinal series.
            </div>
          </div>
        )}
      </div>

      {/* Footer */}
      <div className="page-gutter" style={{ paddingTop: 24, paddingBottom: 24, textAlign: "center", fontSize: T.caption, color: "#333", letterSpacing: "0.02em" }}>
        Built by <a href="https://monsurate.com" style={{ color: "#5a5e6a", textDecoration: "none", fontWeight: 500, borderBottom: "1px solid rgba(255,255,255,0.06)" }} onMouseEnter={e => e.target.style.color = "#8a8e9a"} onMouseLeave={e => e.target.style.color = "#5a5e6a"}>Ryan Monsurate</a> &middot; Data from BC Budget 2026, CIHI, Fraser Institute
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<BCBudgetV2 />);
  </script>
</body>
</html>